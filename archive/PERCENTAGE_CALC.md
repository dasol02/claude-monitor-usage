# í¼ì„¼íŠ¸ ê³„ì‚° ë¡œì§ ì •ë¦¬

## 1ï¸âƒ£ ì›ë³¸ í¼ì„¼íŠ¸ ê³„ì‚° (monitor_daemon.py)

### ğŸ“ ìœ„ì¹˜: `monitor_daemon.py:275-304`

```python
def calculate_usage_percentage(usage, limits):
    """ì‚¬ìš©ëŸ‰ í¼ì„¼íŠ¸ ê³„ì‚°"""

    window_minutes = limits['window_hours'] * 60  # 5ì‹œê°„ = 300ë¶„

    # === INPUT í¼ì„¼íŠ¸ ===
    total_input_limit = limits['input_tokens_per_minute'] * window_minutes
    # ì˜ˆ: 40,000 TPM * 300ë¶„ = 12,000,000 tokens

    input_total = usage['input_tokens'] + usage['cache_creation_tokens']
    input_pct = (input_total / total_input_limit) * 100
    # ì˜ˆ: 3,200,000 / 12,000,000 * 100 = 26.7%


    # === OUTPUT í¼ì„¼íŠ¸ ===
    total_output_limit = limits['output_tokens_per_minute'] * window_minutes
    # ì˜ˆ: 1,611 TPM * 300ë¶„ = 483,300 tokens

    output_pct = (usage['output_tokens'] / total_output_limit) * 100
    # ì˜ˆ: 103,000 / 483,300 * 100 = 21.3%


    # === ìµœì¢… í¼ì„¼íŠ¸ ===
    max_pct = max(input_pct, output_pct)
    # ì˜ˆ: max(26.7%, 21.3%) = 26.7%

    return {
        'input_percentage': 26.7,
        'output_percentage': 21.3,
        'max_percentage': 26.7   # â† ì´ ê°’ì´ ì›ë³¸ í¼ì„¼íŠ¸
    }
```

**ê²°ê³¼: 26.7% (ì›ë³¸)**

---

## 2ï¸âƒ£ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ëœ í¼ì„¼íŠ¸ ê³„ì‚°

### ë°©ë²• A: Offset ê¸°ë°˜ (ì´ˆê¸° í•™ìŠµ)

ğŸ“ ìœ„ì¹˜: `calibration_learner.py:373-375`

```python
# ëª¨ë‹ˆí„° ê°’ + í•™ìŠµëœ offset
calibrated_value = monitor_value + model['offset_mean']

# ì˜ˆì‹œ:
# - monitor_value = 0.267 (26.7%)
# - offset_mean = 0.097 (9.7%)
# â†’ calibrated_value = 0.364 (36.4%)
```

**ê²°ê³¼: 36.4% (ìº˜ë¦¬ë¸Œë ˆì´ì…˜)**

---

### ë°©ë²• B: Limit ê¸°ë°˜ (ì¶©ë¶„í•œ í•™ìŠµ í›„)

ğŸ“ ìœ„ì¹˜: `calibration_learner.py:351-366`

```python
# 1. í•™ìŠµëœ limitìœ¼ë¡œ ì‹¤ì œ í¼ì„¼íŠ¸ ê³„ì‚°
input_pct = (input_total / (learned_input_limit * 300)) * 100
output_pct = (output_total / (learned_output_limit * 300)) * 100
calibrated_value = max(input_pct, output_pct) / 100.0

# ì˜ˆì‹œ:
# - output_tokens = 103,000
# - learned_output_limit = 940 TPM (í•™ìŠµëœ ì‹¤ì œ limit)
# â†’ output_pct = (103,000 / (940 * 300)) * 100 = 36.5%
```

**ê²°ê³¼: 36.5% (ìº˜ë¦¬ë¸Œë ˆì´ì…˜)**

---

## 3ï¸âƒ£ ìµœì¢… í‘œì‹œ ê°’ ê²°ì •

### ğŸ“ ìœ„ì¹˜: `monitor_daemon.py:545-565`

```python
# ê¸°ë³¸ê°’ì€ ì›ë³¸
display_percentage = 26.7  # ì›ë³¸ í¼ì„¼íŠ¸

# ìº˜ë¦¬ë¸Œë ˆì´ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆê³ 
if CALIBRATION_ENABLED:
    # ìƒ˜í”Œì´ 3ê°œ ì´ìƒì´ë©´
    if calibration['status'] in ['calibrated', 'learning']:
        # ìº˜ë¦¬ë¸Œë ˆì´ì…˜ëœ ê°’ ì‚¬ìš©
        display_percentage = 36.5  # ìº˜ë¦¬ë¸Œë ˆì´ì…˜ëœ í¼ì„¼íŠ¸
```

**ìµœì¢… ê²°ê³¼:**
- âŒ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì—†ìŒ â†’ **26.7%** í‘œì‹œ
- âœ… ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ìˆìŒ â†’ **36.5%** í‘œì‹œ

---

## 4ï¸âƒ£ ì „ì²´ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. í† í° ì‚¬ìš©ëŸ‰ ì§‘ê³„                â”‚
â”‚     - input: 6,000                  â”‚
â”‚     - output: 103,000               â”‚
â”‚     - cache_creation: 3,200,000     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ì›ë³¸ í¼ì„¼íŠ¸ ê³„ì‚°                â”‚
â”‚     input_pct = 26.7%               â”‚
â”‚     output_pct = 21.3%              â”‚
â”‚     max_pct = 26.7%  â† ì›ë³¸         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í™•ì¸                â”‚
â”‚     ìƒ˜í”Œ 3ê°œ ì´ìƒ?                   â”‚
â”‚     YES â†’ offset ì ìš©               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ìº˜ë¦¬ë¸Œë ˆì´ì…˜ëœ í¼ì„¼íŠ¸           â”‚
â”‚     26.7% + 9.7% = 36.4%            â”‚
â”‚     ë˜ëŠ”                             â”‚
â”‚     limit ê¸°ë°˜ = 36.5%              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. ìµœì¢… í‘œì‹œ                        â”‚
â”‚     ğŸŸ¢ 36.5%                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ì‹¤ì œ ì˜ˆì‹œ

### í˜„ì¬ ìƒíƒœ:
```json
{
  "session": {
    "usage": {
      "output_tokens": 103279
    },
    "percentages": {
      "max_percentage": 26.2    // â† ì›ë³¸ (configì˜ limit ê¸°ì¤€)
    }
  },
  "calibration": {
    "info": {
      "original_percentage": 26.2,
      "calibrated_percentage": 36.5,   // â† ìº˜ë¦¬ë¸Œë ˆì´ì…˜ (ì‹¤ì œ limit ê¸°ì¤€)
      "offset_applied": 9.7,
      "confidence": 0.63
    }
  }
}
```

### ì™œ ì°¨ì´ê°€ ë‚˜ëŠ”ê°€?

**ì›ë³¸ ê³„ì‚° (26.2%):**
- Configì— ì„¤ì •ëœ limit ì‚¬ìš©: `1,611 TPM`
- 103,279 / (1,611 * 300) = **21.4%** (output)
- Cache í¬í•¨ inputì´ ë” ë†’ì•„ì„œ **26.2%**

**ìº˜ë¦¬ë¸Œë ˆì´ì…˜ (36.5%):**
- ì‹¤ì œ í•™ìŠµëœ limit ì‚¬ìš©: `940 TPM` â† ì‹¤ì œëŠ” ì´ê²Œ ë§ìŒ
- 103,279 / (940 * 300) = **36.6%** (output)

â†’ Configì˜ 1,611 TPMì´ **ì˜ëª»ëœ ê°’**ì´ê³ , ì‹¤ì œëŠ” 940 TPMì´ë¼ì„œ ì°¨ì´ê°€ ë‚¨!

---

## âœ… ìš”ì•½

| í•­ëª© | ê°’ | ì„¤ëª… |
|------|-----|------|
| Config limit | 1,611 TPM | ì„¤ì • íŒŒì¼ì˜ ê°’ (ë¶€ì •í™•) |
| ì›ë³¸ í¼ì„¼íŠ¸ | 26.2% | Config limit ê¸°ì¤€ ê³„ì‚° |
| **ì‹¤ì œ limit** | **940 TPM** | í•™ìŠµìœ¼ë¡œ ë°œê²¬í•œ ì‹¤ì œ ê°’ |
| **ìº˜ë¦¬ë¸Œë ˆì´ì…˜ í¼ì„¼íŠ¸** | **36.5%** | ì‹¤ì œ limit ê¸°ì¤€ ê³„ì‚° âœ… |
| ì°¨ì´ | +10.3% | offset |

**ê²°ë¡ : 36.5%ê°€ ì‹¤ì œ ì‚¬ìš©ëŸ‰ì— ê°€ê¹Œìš´ ì •í™•í•œ ê°’ì…ë‹ˆë‹¤.**
