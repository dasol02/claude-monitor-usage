#!/bin/bash
# Claude Session Reset Time Configuration Tool
# ì„¸ì…˜ ë¦¬ì…‹ ì‹œê°„ ì…ë ¥ â†’ ìë™ìœ¼ë¡œ base hour ê³„ì‚°

CONFIG_FILE="$HOME/.claude-monitor/config.json"

# Usage ì¶œë ¥
show_usage() {
    echo ""
    echo "Usage: claude-set-session-resets <hour>"
    echo ""
    echo "Set the session reset time. The base hour will be calculated automatically."
    echo ""
    echo "Examples:"
    echo "  claude-set-session-resets 19  # Sessions reset at 19:00 (current: 14:00-19:00)"
    echo "  claude-set-session-resets 20  # Sessions reset at 20:00 (current: 15:00-20:00)"
    echo "  claude-set-session-resets 8   # Sessions reset at 08:00 (current: 03:00-08:00)"
    echo ""

    if [ -f "$CONFIG_FILE" ]; then
        BASE_HOUR=$(jq -r '.reset_schedule.session_base_hour // 14' "$CONFIG_FILE")
        RESET_HOUR=$((($BASE_HOUR + 5) % 24))

        echo "Current configuration:"
        echo "  Reset time: $(printf '%02d:00' $RESET_HOUR)"
        echo "  Base hour: $BASE_HOUR"
        echo ""
        echo "  Current session windows:"
        CURRENT_START=$BASE_HOUR
        for i in {0..4}; do
            START=$CURRENT_START
            END=$((($START + 5) % 24))
            printf "  - %02d:00-%02d:00" $START $END
            if [ $i -eq 0 ]; then
                echo " â† First session resets at $(printf '%02d:00' $END)"
            else
                echo ""
            fi
            CURRENT_START=$END
        done
    else
        echo "Configuration file not found!"
    fi
    echo ""
}

# ì¸ì í™•ì¸
if [ $# -eq 0 ] || [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
    show_usage
    exit 0
fi

# Reset hour íŒŒì‹±
RESET_HOUR="$1"

# ìˆ«ì í™•ì¸
if ! [[ "$RESET_HOUR" =~ ^[0-9]+$ ]]; then
    echo "âŒ Error: Hour must be a number (0-23)"
    exit 1
fi

# ë²”ìœ„ í™•ì¸
if [ "$RESET_HOUR" -lt 0 ] || [ "$RESET_HOUR" -gt 23 ]; then
    echo "âŒ Error: Hour must be between 0 and 23"
    exit 1
fi

# Config íŒŒì¼ í™•ì¸
if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ Error: Configuration file not found at $CONFIG_FILE"
    exit 1
fi

# Base hour ê³„ì‚° (reset_hour - 5)
NEW_BASE_HOUR=$((($RESET_HOUR - 5 + 24) % 24))

# í˜„ì¬ ì„¤ì • í‘œì‹œ
CURRENT_BASE=$(jq -r '.reset_schedule.session_base_hour // 14' "$CONFIG_FILE")
CURRENT_RESET=$((($CURRENT_BASE + 5) % 24))

echo ""
echo "ğŸ“Š Current reset time: $(printf '%02d:00' $CURRENT_RESET) (base: $CURRENT_BASE)"
echo ""
echo "ğŸ”„ Changing reset time to: $(printf '%02d:00' $RESET_HOUR)"
echo "   â†’ Calculated base hour: $NEW_BASE_HOUR"
echo ""

# New session windows ê³„ì‚°
echo "New session windows:"
CURRENT_START=$NEW_BASE_HOUR
for i in {0..4}; do
    START=$CURRENT_START
    END=$((($START + 5) % 24))
    printf "  - %02d:00-%02d:00" $START $END
    if [ $i -eq 0 ]; then
        echo " â† First session resets at $(printf '%02d:00' $END)"
    else
        echo ""
    fi
    CURRENT_START=$END
done
echo ""

# í™•ì¸ í”„ë¡¬í”„íŠ¸
read -p "Continue? (y/N): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Cancelled"
    exit 0
fi

# JSON ì—…ë°ì´íŠ¸
TMP_FILE=$(mktemp)
jq ".reset_schedule.session_base_hour = $NEW_BASE_HOUR" "$CONFIG_FILE" > "$TMP_FILE"

if [ $? -eq 0 ]; then
    mv "$TMP_FILE" "$CONFIG_FILE"
    echo ""
    echo "âœ… Session reset time updated to $(printf '%02d:00' $RESET_HOUR)"
    echo "   Base hour set to: $NEW_BASE_HOUR"
    echo ""

    # ìë™ìœ¼ë¡œ ë°ëª¬ ì¬ì‹œì‘ ë° SwiftBar ê°±ì‹ 
    echo "ğŸ”„ Restarting monitor daemon..."
    killall claude-usage-monitor 2>/dev/null
    sleep 0.5
    ~/.local/bin/claude-usage-monitor &
    echo "âœ… Monitor daemon restarted"
    echo ""

    echo "ğŸ”„ Refreshing SwiftBar..."
    open "swiftbar://refreshallplugins" 2>/dev/null
    echo "âœ… SwiftBar refreshed"
    echo ""

    echo "ğŸ’¡ Tip: If needed, recalibrate with: claude-calibrate <actual_%>"
    echo ""
else
    rm "$TMP_FILE"
    echo "âŒ Error: Failed to update configuration"
    exit 1
fi
