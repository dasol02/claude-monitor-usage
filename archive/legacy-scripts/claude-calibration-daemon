#!/usr/bin/env python3
"""
Claude Calibration Daemon
30ë¶„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ë³´ì • ì‹¤í–‰
"""

import time
import sys
from pathlib import Path
from datetime import datetime
from zoneinfo import ZoneInfo

# calibration_learner ëª¨ë“ˆ ì„í¬íŠ¸ë¥¼ ìœ„í•œ ê²½ë¡œ ì¶”ê°€
sys.path.insert(0, str(Path.home() / 'claude-monitor'))

try:
    from calibration_learner import calibrate_once, load_calibration_model
except ImportError:
    print("âŒ calibration_learner module not found")
    print("   Please ensure calibration_learner.py is in ~/claude-monitor/")
    sys.exit(1)


def daemon_mode(interval_minutes=30):
    """
    ë°ëª¬ ëª¨ë“œë¡œ ì§€ì† ì‹¤í–‰

    Args:
        interval_minutes: ì‹¤í–‰ ê°„ê²© (ë¶„), ê¸°ë³¸ 30ë¶„
    """
    tz = ZoneInfo('Asia/Seoul')
    interval_seconds = interval_minutes * 60

    print(f"ğŸ”¬ Claude Calibration Daemon started")
    print(f"   Interval: {interval_minutes} minutes")
    print(f"   Press Ctrl+C to stop\n")

    try:
        run_count = 0

        while True:
            run_count += 1
            now = datetime.now(tz).strftime('%Y-%m-%d %H:%M:%S')

            print(f"\n{'='*60}")
            print(f"[{now}] Calibration run #{run_count}")
            print(f"{'='*60}")

            # ë³´ì • ì‹¤í–‰
            try:
                result = calibrate_once()

                if result['status'] == 'success':
                    # í˜„ì¬ ëª¨ë¸ ìƒíƒœ ì¶œë ¥
                    model = load_calibration_model()

                    print(f"\nğŸ“Š Current Model Status:")
                    print(f"   Samples: {model['sample_count']}")
                    print(f"   Offset: {model['offset_mean']*100:+.2f}%")
                    print(f"   Confidence: {model['confidence']:.2f}")
                    print(f"   Status: {model['status']}")

                    if model['sample_count'] >= 100:
                        print(f"   âœ… Model is ready for production use!")
                    else:
                        remaining = 100 - model['sample_count']
                        print(f"   â³ Need {remaining} more samples to reach production")
                else:
                    print(f"âš ï¸  Calibration failed: {result.get('message', 'Unknown error')}")

            except Exception as e:
                print(f"âŒ Error during calibration: {e}")

            # ë‹¤ìŒ ì‹¤í–‰ê¹Œì§€ ëŒ€ê¸°
            next_run = datetime.now(tz)
            next_run = next_run.replace(second=0, microsecond=0)
            next_run = next_run.replace(minute=(next_run.minute // interval_minutes + 1) * interval_minutes % 60)
            if next_run.minute == 0:
                next_run = next_run.replace(hour=next_run.hour + 1)

            print(f"\nğŸ’¤ Sleeping until next run at {next_run.strftime('%H:%M')}...")
            time.sleep(interval_seconds)

    except KeyboardInterrupt:
        print("\n\nâœ… Calibration daemon stopped")


def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    import argparse

    parser = argparse.ArgumentParser(description='Claude Calibration Daemon')
    parser.add_argument('--interval', type=int, default=30,
                        help='Calibration interval in minutes (default: 30)')
    parser.add_argument('--once', action='store_true',
                        help='Run once and exit')

    args = parser.parse_args()

    if args.once:
        # í•œ ë²ˆë§Œ ì‹¤í–‰
        result = calibrate_once()

        if result['status'] == 'success':
            model = load_calibration_model()
            print(f"\nğŸ“Š Model Status:")
            print(f"   Samples: {model['sample_count']}")
            print(f"   Confidence: {model['confidence']:.2f}")
            print(f"   Status: {model['status']}")
    else:
        # ë°ëª¬ ëª¨ë“œ
        daemon_mode(args.interval)


if __name__ == '__main__':
    main()
