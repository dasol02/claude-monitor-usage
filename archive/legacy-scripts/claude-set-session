#!/bin/bash
# Claude Session Time Configuration Tool
# ì„¸ì…˜ ì‹œì‘ ì‹œê°„ ì„¤ì • (5ì‹œê°„ ìœˆë„ìš° ê¸°ì¤€)

CONFIG_FILE="$HOME/.claude-monitor/config.json"

# Usage ì¶œë ¥
show_usage() {
    echo ""
    echo "Usage: claude-set-session <hour>"
    echo ""
    echo "Set the base hour for 5-hour session windows."
    echo ""
    echo "Examples:"
    echo "  claude-set-session 14  # 14:00-19:00, 19:00-00:00, 00:00-05:00, 05:00-10:00, 10:00-14:00"
    echo "  claude-set-session 15  # 15:00-20:00, 20:00-01:00, 01:00-06:00, 06:00-11:00, 11:00-15:00"
    echo "  claude-set-session 16  # 16:00-21:00, 21:00-02:00, 02:00-07:00, 07:00-12:00, 12:00-16:00"
    echo ""
    echo "Note: All windows are 5 hours long. Last window completes the 24-hour cycle."
    echo ""
    echo "Current configuration:"
    if [ -f "$CONFIG_FILE" ]; then
        CURRENT=$(jq -r '.reset_schedule.session_base_hour // 14' "$CONFIG_FILE")
        echo "  Base hour: $CURRENT"
        echo ""
        echo "  Session windows:"
        CURRENT_START=$CURRENT
        for i in {0..4}; do
            START=$CURRENT_START
            END=$((($START + 5) % 24))
            printf "  - %02d:00-%02d:00\n" $START $END
            CURRENT_START=$END
        done
    else
        echo "  Configuration file not found!"
    fi
    echo ""
}

# ì¸ì í™•ì¸
if [ $# -eq 0 ] || [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
    show_usage
    exit 0
fi

# hour íŒŒì‹±
NEW_HOUR="$1"

# ìˆ«ì í™•ì¸
if ! [[ "$NEW_HOUR" =~ ^[0-9]+$ ]]; then
    echo "âŒ Error: Hour must be a number (0-23)"
    exit 1
fi

# ë²”ìœ„ í™•ì¸
if [ "$NEW_HOUR" -lt 0 ] || [ "$NEW_HOUR" -gt 23 ]; then
    echo "âŒ Error: Hour must be between 0 and 23"
    exit 1
fi

# Config íŒŒì¼ í™•ì¸
if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ Error: Configuration file not found at $CONFIG_FILE"
    echo "   Please run setup first."
    exit 1
fi

# í˜„ì¬ ì„¤ì • í‘œì‹œ
CURRENT=$(jq -r '.reset_schedule.session_base_hour // 14' "$CONFIG_FILE")
echo ""
echo "ğŸ“Š Current session base hour: $CURRENT"
echo ""
echo "ğŸ”„ Changing to: $NEW_HOUR"
echo ""

# New session windows ê³„ì‚°
echo "New session windows:"
CURRENT_START=$NEW_HOUR
for i in {0..4}; do
    START=$CURRENT_START
    END=$((($START + 5) % 24))
    printf "  - %02d:00-%02d:00\n" $START $END
    CURRENT_START=$END
done
echo ""

# í™•ì¸ í”„ë¡¬í”„íŠ¸
read -p "Continue? (y/N): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Cancelled"
    exit 0
fi

# JSON ì—…ë°ì´íŠ¸ (jq ì‚¬ìš©)
TMP_FILE=$(mktemp)
jq ".reset_schedule.session_base_hour = $NEW_HOUR" "$CONFIG_FILE" > "$TMP_FILE"

if [ $? -eq 0 ]; then
    mv "$TMP_FILE" "$CONFIG_FILE"
    echo ""
    echo "âœ… Session base hour updated to $NEW_HOUR"
    echo ""
    echo "âš ï¸  Important:"
    echo "  1. Restart monitor daemon to apply changes"
    echo "  2. Existing calibration data uses old window keys"
    echo "  3. You may need to recalibrate for new windows"
    echo ""
    echo "Commands:"
    echo "  killall claude-usage-monitor  # Stop daemon"
    echo "  ~/.local/bin/claude-usage-monitor &  # Restart daemon"
    echo "  claude-calibrate --status  # Check calibration data"
    echo ""
else
    rm "$TMP_FILE"
    echo "âŒ Error: Failed to update configuration"
    exit 1
fi
