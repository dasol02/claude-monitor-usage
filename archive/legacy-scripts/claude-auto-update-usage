#!/bin/bash
# Chrome Extensionì—ì„œ ìƒì„±í•œ usage íŒŒì¼ì„ ì½ì–´ì„œ ìë™ calibration
# ìœ„ì¹˜: ~/.local/bin/claude-auto-update-usage

# Step 1: Sync from Downloads to /tmp
SOURCE_FILE="$HOME/Downloads/claude-auto-usage.json"
USAGE_FILE="/tmp/claude-auto-usage.json"

if [ -f "$SOURCE_FILE" ]; then
    cp "$SOURCE_FILE" "$USAGE_FILE" 2>/dev/null
    rm "$SOURCE_FILE" 2>/dev/null || true
    echo "[SYNC] $(date): Synced extension data"
fi

# Step 2: Process the file
echo "[DEBUG] $(date): Script started"
echo "[DEBUG] PATH=$PATH"
echo "[DEBUG] which jq: $(which jq 2>&1)"
echo "[DEBUG] which claude-calibrate: $(which claude-calibrate 2>&1)"

if [ -f "$USAGE_FILE" ]; then
    echo "[DEBUG] File exists: $USAGE_FILE"
    echo "[DEBUG] File content: $(cat "$USAGE_FILE")"

    # JSON íŒŒì‹±
    SESSION=$(jq -r '.session' "$USAGE_FILE" 2>&1)
    WEEKLY=$(jq -r '.weekly' "$USAGE_FILE" 2>&1)

    echo "[DEBUG] SESSION='$SESSION'"
    echo "[DEBUG] WEEKLY='$WEEKLY'"
    echo "[DEBUG] Test conditions:"
    echo "[DEBUG]   SESSION != null: $([ "$SESSION" != "null" ] && echo true || echo false)"
    echo "[DEBUG]   WEEKLY != null: $([ "$WEEKLY" != "null" ] && echo true || echo false)"
    echo "[DEBUG]   -n SESSION: $([ -n "$SESSION" ] && echo true || echo false)"

    if [ "$SESSION" != "null" ] && [ "$WEEKLY" != "null" ] && [ -n "$SESSION" ]; then
        echo "ğŸ“Š Auto-updating usage from Chrome Extension"
        echo "   Session: ${SESSION}%, Weekly: ${WEEKLY}%"

        # Calibrate (ìë™ìœ¼ë¡œ monitor ì—…ë°ì´íŠ¸ & SwiftBar ìƒˆë¡œê³ ì¹¨)
        claude-calibrate $SESSION $WEEKLY

        # íŒŒì¼ ì‚­ì œ (ì²˜ë¦¬ ì™„ë£Œ)
        rm "$USAGE_FILE"

        echo "âœ… Usage updated successfully!"
    else
        echo "âš ï¸  Invalid data in usage file"
        rm "$USAGE_FILE"
    fi
else
    # íŒŒì¼ ì—†ìŒ (ì •ìƒ - ì•„ì§ Extensionì´ ìƒì„± ì•ˆ í•¨)
    exit 0
fi
