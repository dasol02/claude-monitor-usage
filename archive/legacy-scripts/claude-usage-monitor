#!/usr/bin/env python3
"""
Claude Usage Monitor - Daemon v2
ì„¸ì…˜(5ì‹œê°„) ë° ì£¼ê°„ ì‚¬ìš©ëŸ‰ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  JSON ì¶œë ¥
"""

import json
import os
import time
from pathlib import Path
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo
import argparse

# Calibration learner import
try:
    from calibration_learner import get_calibrated_value, get_session_window_key, get_weekly_window_key
    CALIBRATION_ENABLED = True
except ImportError:
    CALIBRATION_ENABLED = False


CONFIG_FILE = Path.home() / '.claude-monitor' / 'config.json'
OUTPUT_FILE = Path.home() / '.claude_usage.json'
NOTIFICATION_STATE_FILE = Path.home() / '.claude-monitor' / 'notification_state.json'


def load_config():
    """ì„¤ì • íŒŒì¼ ë¡œë“œ"""
    if not CONFIG_FILE.exists():
        print(f"âŒ Configuration not found at {CONFIG_FILE}")
        print("   Please run: python3 src/config_manager.py")
        return None

    with open(CONFIG_FILE, 'r') as f:
        config = json.load(f)

    # Timezone ì„¤ì • ì¶”ê°€ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
    if 'display_settings' not in config:
        config['display_settings'] = {}
    if 'timezone' not in config['display_settings']:
        config['display_settings']['timezone'] = 'Asia/Seoul'
    if 'timezone_abbr' not in config['display_settings']:
        config['display_settings']['timezone_abbr'] = 'KST'

    return config


def find_all_sessions():
    """ëª¨ë“  Claude í”„ë¡œì íŠ¸ì˜ ì„¸ì…˜ íŒŒì¼ ì°¾ê¸°"""
    home = Path.home()
    projects_dir = home / '.claude' / 'projects'

    if not projects_dir.exists():
        return []

    session_files = list(projects_dir.rglob('*.jsonl'))
    return session_files


def get_rolling_session_window(session_files, now, tz):
    """
    Rolling 5ì‹œê°„ ì„¸ì…˜ ìœˆë„ìš° ê³„ì‚° (ì‚¬ìš© ì•ˆ í•¨)

    í˜„ì¬ ì„¸ì…˜ì˜ ê°€ì¥ ì˜¤ë˜ëœ ë©”ì‹œì§€ ì‹œì‘ ì‹œì ë¶€í„° +5ì‹œê°„

    Args:
        session_files: ì„¸ì…˜ íŒŒì¼ ë¦¬ìŠ¤íŠ¸
        now: í˜„ì¬ ì‹œê°„
        tz: Timezone

    Returns:
        tuple: (window_start, window_end, next_reset)
    """
    # ì¼ë‹¨ í˜„ì¬ ì‹œê°„ë¶€í„° 5ì‹œê°„ ì „ê¹Œì§€ ëª¨ë“  ë©”ì‹œì§€ ìŠ¤ìº”
    potential_start = now - timedelta(hours=5)

    oldest_message_time = None

    # ëª¨ë“  ì„¸ì…˜ íŒŒì¼ì—ì„œ 5ì‹œê°„ ë‚´ ê°€ì¥ ì˜¤ë˜ëœ ë©”ì‹œì§€ ì°¾ê¸°
    for session_file in session_files:
        try:
            with open(session_file, 'r') as f:
                for line in f:
                    try:
                        data = json.loads(line.strip())

                        if data.get('type') == 'assistant' and 'message' in data:
                            timestamp_str = data.get('timestamp')
                            if not timestamp_str:
                                continue

                            msg_time = datetime.fromisoformat(timestamp_str.replace('Z', '+00:00'))
                            msg_time = msg_time.astimezone(tz)

                            # 5ì‹œê°„ ì´ë‚´ì˜ ë©”ì‹œì§€ë§Œ
                            if msg_time >= potential_start and msg_time <= now:
                                if oldest_message_time is None or msg_time < oldest_message_time:
                                    oldest_message_time = msg_time
                    except:
                        continue
        except:
            continue

    # ê°€ì¥ ì˜¤ë˜ëœ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ê·¸ ì‹œì ë¶€í„° +5ì‹œê°„
    if oldest_message_time:
        window_start = oldest_message_time
        window_end = oldest_message_time + timedelta(hours=5)
        next_reset = window_end
    else:
        # ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ ê¸°ì¤€
        window_start = now
        window_end = now + timedelta(hours=5)
        next_reset = window_end

    return window_start, window_end, next_reset


def get_fixed_session_window(now, config=None):
    """
    ê³ ì •ëœ 5ì‹œê°„ ì„¸ì…˜ ìœˆë„ìš° ê³„ì‚° (config ê¸°ë°˜)

    configì˜ session_base_hourë¥¼ ê¸°ì¤€ìœ¼ë¡œ 5ì‹œê°„ ìœˆë„ìš° ê³„ì‚°
    ì˜ˆ: base=14 â†’ 14:00-19:00, 19:00-00:00, 00:00-04:00, 04:00-09:00, 09:00-14:00
    ì˜ˆ: base=15 â†’ 15:00-20:00, 20:00-01:00, 01:00-05:00, 05:00-10:00, 10:00-15:00

    Returns:
        tuple: (window_start, window_end, next_reset)
    """
    # Configì—ì„œ base hour ì½ê¸° (ê¸°ë³¸: 14)
    base_hour = 14
    if config and 'reset_schedule' in config:
        base_hour = config['reset_schedule'].get('session_base_hour', 14)

    hour = now.hour

    # Base hourë¥¼ ê¸°ì¤€ìœ¼ë¡œ 5ê°œì˜ 5ì‹œê°„ ìœˆë„ìš° ìƒì„±
    windows = []
    current_start = base_hour
    for _ in range(5):
        current_end = (current_start + 5) % 24
        windows.append((current_start, current_end))
        current_start = current_end

    # í˜„ì¬ ì‹œê°„ì´ ì†í•œ ìœˆë„ìš° ì°¾ê¸°
    start_hour = None
    end_hour = None
    for win_start, win_end in windows:
        if win_end < win_start:  # ìì •ì„ ë„˜ì–´ê°€ëŠ” ê²½ìš°
            if hour >= win_start or hour < win_end:
                start_hour = win_start
                end_hour = win_end
                break
        else:  # ê°™ì€ ë‚  ë‚´
            if win_start <= hour < win_end:
                start_hour = win_start
                end_hour = win_end
                break

    # ì°¾ì§€ ëª»í•˜ë©´ ê¸°ë³¸ê°’ (base_hour ì‹œì‘)
    if start_hour is None:
        start_hour = base_hour
        end_hour = (base_hour + 5) % 24

    # ì‹œì‘ ì‹œê°„ ê³„ì‚°
    if hour < start_hour:
        # ì „ë‚ ì—ì„œ ì‹œì‘
        window_start = now.replace(hour=start_hour, minute=0, second=0, microsecond=0) - timedelta(days=1)
    else:
        window_start = now.replace(hour=start_hour, minute=0, second=0, microsecond=0)

    # ì¢…ë£Œ ì‹œê°„ ê³„ì‚°
    if end_hour < start_hour:
        # ë‹¤ìŒë‚ ë¡œ ë„˜ì–´ê°
        window_end = (window_start + timedelta(days=1)).replace(hour=end_hour, minute=0, second=0, microsecond=0)
    else:
        window_end = window_start.replace(hour=end_hour, minute=0, second=0, microsecond=0)

    # ë‹¤ìŒ ë¦¬ì…‹ ì‹œê°„
    next_reset = window_end

    return window_start, window_end, next_reset


def get_weekly_window(now):
    """
    ì£¼ê°„ ìœˆë„ìš° ê³„ì‚° (7ì¼ = 168ì‹œê°„)

    í˜„ì¬ ì‹œê°„ìœ¼ë¡œë¶€í„° 7ì¼ ì „

    Returns:
        tuple: (window_start, window_end, next_reset)
    """
    window_end = now
    window_start = now - timedelta(days=7)

    # ë‹¤ìŒ ë¦¬ì…‹ì€ ë§¤ì£¼ í™”ìš”ì¼ (ê°€ì •)
    # ì‹¤ì œë¡œëŠ” ê²°ì œì¼ ê¸°ì¤€ì´ì§€ë§Œ, ì¼ë‹¨ 7ì¼ ë¡¤ë§ìœ¼ë¡œ ì²˜ë¦¬
    next_reset = now + timedelta(days=1)  # ì„ì‹œ

    return window_start, window_end, next_reset


def parse_sessions_in_window(session_files, window_start, window_end, tz):
    """
    íŠ¹ì • ì‹œê°„ ìœˆë„ìš° ë‚´ì˜ ëª¨ë“  ì„¸ì…˜ì—ì„œ í† í° ì‚¬ìš©ëŸ‰ ì§‘ê³„

    Args:
        session_files: ì„¸ì…˜ íŒŒì¼ ë¦¬ìŠ¤íŠ¸
        window_start: ìœˆë„ìš° ì‹œì‘ ì‹œê°„ (datetime)
        window_end: ìœˆë„ìš° ì¢…ë£Œ ì‹œê°„ (datetime)
        tz: Timezone

    Returns:
        dict: ì‚¬ìš©ëŸ‰ ì •ë³´
    """
    usage_data = {
        'input_tokens': 0,
        'output_tokens': 0,
        'cache_read_tokens': 0,
        'cache_creation_tokens': 0,
        'total_counted_tokens': 0,
        'messages_count': 0,
        'oldest_message_time': None,
        'latest_message_time': None
    }

    for session_file in session_files:
        with open(session_file, 'r') as f:
            for line in f:
                try:
                    data = json.loads(line.strip())

                    # assistant ë©”ì‹œì§€ì—ì„œ usage ì •ë³´ ì¶”ì¶œ
                    if data.get('type') == 'assistant' and 'message' in data:
                        message = data['message']

                        # íƒ€ì„ìŠ¤íƒ¬í”„ í™•ì¸
                        timestamp_str = data.get('timestamp')
                        if not timestamp_str:
                            continue

                        msg_time = datetime.fromisoformat(timestamp_str.replace('Z', '+00:00'))
                        msg_time = msg_time.astimezone(tz)

                        # ìœˆë„ìš° ë‚´ì˜ ë©”ì‹œì§€ë§Œ ì§‘ê³„
                        if msg_time < window_start or msg_time > window_end:
                            continue

                        # ì‹œê°„ ì¶”ì 
                        if usage_data['oldest_message_time'] is None:
                            usage_data['oldest_message_time'] = msg_time
                        usage_data['latest_message_time'] = msg_time

                        if 'usage' in message:
                            usage = message['usage']

                            usage_data['input_tokens'] += usage.get('input_tokens', 0)
                            usage_data['output_tokens'] += usage.get('output_tokens', 0)
                            usage_data['cache_read_tokens'] += usage.get('cache_read_input_tokens', 0)
                            usage_data['cache_creation_tokens'] += usage.get('cache_creation_input_tokens', 0)
                            usage_data['messages_count'] += 1

                except (json.JSONDecodeError, Exception):
                    continue

    # Cache read tokensëŠ” rate limitì— ì¹´ìš´íŠ¸ë˜ì§€ ì•ŠìŒ
    usage_data['total_counted_tokens'] = (
        usage_data['input_tokens'] +
        usage_data['output_tokens'] +
        usage_data['cache_creation_tokens']
    )

    return usage_data


def calculate_usage_percentage(usage, limits):
    """
    ì‚¬ìš©ëŸ‰ í¼ì„¼íŠ¸ ê³„ì‚°

    Args:
        usage: ì‚¬ìš©ëŸ‰ ë°ì´í„°
        limits: rate limit ì„¤ì • (session ë˜ëŠ” weekly)
    """
    window_minutes = limits['window_hours'] * 60

    # ìœˆë„ìš° ë™ì•ˆ ì‚¬ìš© ê°€ëŠ¥í•œ ì´ í† í°
    total_input_limit = limits['input_tokens_per_minute'] * window_minutes
    total_output_limit = limits['output_tokens_per_minute'] * window_minutes

    # í¼ì„¼íŠ¸ ê³„ì‚°
    # Input: input_tokens + cache_creation_tokens (ìºì‹œ ìƒì„±ì€ inputìœ¼ë¡œ ì¹´ìš´íŠ¸)
    input_total = usage['input_tokens'] + usage['cache_creation_tokens']
    input_pct = (input_total / total_input_limit) * 100 if total_input_limit > 0 else 0

    # Output: output_tokensë§Œ (ì‹¤ì œ ìƒì„±ëœ í† í°)
    output_pct = (usage['output_tokens'] / total_output_limit) * 100 if total_output_limit > 0 else 0

    # ê°€ì¥ ë†’ì€ í¼ì„¼íŠ¸ ì‚¬ìš©
    max_pct = max(input_pct, output_pct)

    return {
        'input_percentage': round(input_pct, 1),
        'output_percentage': round(output_pct, 1),
        'max_percentage': round(max_pct, 1)
    }


def generate_progress_bar(percentage, width=10):
    """ë°°í„°ë¦¬ ìŠ¤íƒ€ì¼ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìƒì„±"""
    if percentage >= 100:
        filled = width
        empty = 0
    else:
        filled = int((percentage / 100) * width)
        empty = width - filled

    bar = '=' * filled + '-' * empty

    return f"[{int(percentage)}% {bar}]"


def load_notification_state():
    """ì•Œë¦¼ ìƒíƒœ íŒŒì¼ ë¡œë“œ"""
    if not NOTIFICATION_STATE_FILE.exists():
        return {
            'session_window_start': None,
            'notified_thresholds': []
        }

    try:
        with open(NOTIFICATION_STATE_FILE, 'r') as f:
            return json.load(f)
    except:
        return {
            'session_window_start': None,
            'notified_thresholds': []
        }


def save_notification_state(state):
    """ì•Œë¦¼ ìƒíƒœ íŒŒì¼ ì €ì¥"""
    NOTIFICATION_STATE_FILE.parent.mkdir(parents=True, exist_ok=True)
    with open(NOTIFICATION_STATE_FILE, 'w') as f:
        json.dump(state, f, indent=2)


def send_macos_notification(title, message, subtitle=None):
    """
    macOS ì•Œë¦¼ ì „ì†¡ (osascript ì‚¬ìš©)

    Args:
        title: ì•Œë¦¼ ì œëª©
        message: ì•Œë¦¼ ë©”ì‹œì§€
        subtitle: ì•Œë¦¼ ë¶€ì œëª© (ì„ íƒ)
    """
    try:
        # AppleScriptë¡œ ì•Œë¦¼ ì „ì†¡
        script = f'display notification "{message}" with title "{title}"'
        if subtitle:
            script = f'display notification "{message}" with title "{title}" subtitle "{subtitle}"'

        os.system(f"osascript -e '{script}'")
    except Exception as e:
        print(f"Failed to send notification: {e}")


def check_and_send_notifications(config, session_percentage, session_window_start):
    """
    ì„ê³„ê°’ì„ í™•ì¸í•˜ê³  ì•Œë¦¼ ì „ì†¡

    Args:
        config: ì„¤ì • ì •ë³´
        session_percentage: í˜„ì¬ ì„¸ì…˜ ì‚¬ìš©ëŸ‰ (%)
        session_window_start: í˜„ì¬ ì„¸ì…˜ ì‹œì‘ ì‹œê°„ (ISO format)

    Returns:
        list: ì „ì†¡ëœ ì•Œë¦¼ì˜ ì„ê³„ê°’ ë¦¬ìŠ¤íŠ¸
    """
    # ì•Œë¦¼ ë¹„í™œì„±í™” ìƒíƒœë©´ ë¦¬í„´
    if not config.get('notifications', {}).get('enabled', True):
        return []

    # ì„ê³„ê°’ ê°€ì ¸ì˜¤ê¸°
    thresholds = config.get('notifications', {}).get('thresholds', [80, 90, 95])

    # ì•Œë¦¼ ìƒíƒœ ë¡œë“œ
    state = load_notification_state()

    # ì„¸ì…˜ ìœˆë„ìš°ê°€ ë°”ë€Œë©´ ìƒíƒœ ë¦¬ì…‹
    if state.get('session_window_start') != session_window_start:
        state = {
            'session_window_start': session_window_start,
            'notified_thresholds': []
        }
        save_notification_state(state)

    # ì„ê³„ê°’ í™•ì¸ ë° ì•Œë¦¼ ì „ì†¡
    notified = []
    for threshold in sorted(thresholds):
        # ì´ë¯¸ ì•Œë¦¼ì„ ë³´ë‚¸ ì„ê³„ê°’ì€ ê±´ë„ˆë›°ê¸°
        if threshold in state['notified_thresholds']:
            continue

        # í˜„ì¬ ì‚¬ìš©ëŸ‰ì´ ì„ê³„ê°’ì„ ë„˜ìœ¼ë©´ ì•Œë¦¼ ì „ì†¡
        if session_percentage >= threshold:
            tz_abbr = config['display_settings']['timezone_abbr']
            send_macos_notification(
                title="âš ï¸ Claude Usage Alert",
                message=f"Session usage has reached {session_percentage}%",
                subtitle=f"Threshold: {threshold}% ({tz_abbr})"
            )

            # ìƒíƒœ ì—…ë°ì´íŠ¸
            state['notified_thresholds'].append(threshold)
            notified.append(threshold)

    # ìƒíƒœ ì €ì¥
    if notified:
        save_notification_state(state)

    return notified


def calculate_time_until_reset(now, reset_time):
    """
    ë¦¬ì…‹ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°

    Args:
        now: í˜„ì¬ ì‹œê°„ (datetime)
        reset_time: ë¦¬ì…‹ ì‹œê°„ (datetime)

    Returns:
        dict: ë‚¨ì€ ì‹œê°„ ì •ë³´
    """
    time_diff = reset_time - now

    # ìŒìˆ˜ë©´ ì´ë¯¸ ì§€ë‚¬ìŒ (0ìœ¼ë¡œ ì²˜ë¦¬)
    if time_diff.total_seconds() < 0:
        return {
            'total_seconds': 0,
            'hours': 0,
            'minutes': 0,
            'human_readable': '0m',
            'human_readable_long': '0 minutes'
        }

    total_seconds = int(time_diff.total_seconds())
    hours = total_seconds // 3600
    minutes = (total_seconds % 3600) // 60

    # Human readable format
    if hours > 0:
        if minutes > 0:
            human_readable = f"{hours}h {minutes}m"
            human_readable_long = f"{hours} hours {minutes} minutes"
        else:
            human_readable = f"{hours}h"
            human_readable_long = f"{hours} hours"
    else:
        human_readable = f"{minutes}m"
        human_readable_long = f"{minutes} minutes"

    return {
        'total_seconds': total_seconds,
        'hours': hours,
        'minutes': minutes,
        'human_readable': human_readable,
        'human_readable_long': human_readable_long
    }


def monitor_once(config):
    """í•œ ë²ˆ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰"""
    # Timezone ì„¤ì •
    tz_name = config['display_settings']['timezone']
    tz_abbr = config['display_settings']['timezone_abbr']
    tz = ZoneInfo(tz_name)

    # ì„¸ì…˜ íŒŒì¼ ì°¾ê¸°
    session_files = find_all_sessions()

    if not session_files:
        # ì„¸ì…˜ íŒŒì¼ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°ì´í„° ë°˜í™˜
        return {
            'status': 'no_session',
            'message': 'No active Claude session found',
            'timestamp': datetime.now(tz).isoformat(),
            'timezone': tz_name,
            'timezone_abbr': tz_abbr
        }

    # í˜„ì¬ ì‹œê°„
    now = datetime.now(tz)

    # Configì—ì„œ limit ë¡œë“œ
    session_limits = config['rate_limits']['session']
    weekly_limits = config['rate_limits']['weekly']

    # ì„¸ì…˜ ìœˆë„ìš° ê³„ì‚° (5ì‹œê°„ ê³ ì •)
    session_start, session_end, session_reset = get_fixed_session_window(now, config)
    session_usage = parse_sessions_in_window(session_files, session_start, session_end, tz)
    session_percentages = calculate_usage_percentage(session_usage, session_limits)

    # ì„¸ì…˜ ë¦¬ì…‹ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
    session_time_until_reset = calculate_time_until_reset(now, session_reset)

    # ì£¼ê°„ ìœˆë„ìš° ê³„ì‚° (7ì¼)
    weekly_start, weekly_end, weekly_reset = get_weekly_window(now)
    weekly_usage = parse_sessions_in_window(session_files, weekly_start, weekly_end, tz)
    weekly_percentages = calculate_usage_percentage(weekly_usage, weekly_limits)

    # ì£¼ê°„ ë¦¬ì…‹ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
    weekly_time_until_reset = calculate_time_until_reset(now, weekly_reset)

    # Calibration ì ìš© (ì„¸ì…˜)
    session_calibration_info = None
    session_display_percentage = session_percentages['max_percentage']  # ê¸°ë³¸ê°’

    if CALIBRATION_ENABLED:
        try:
            window_key = get_session_window_key(session_start)
            monitor_value = session_percentages['max_percentage'] / 100.0
            calibration = get_calibrated_value(monitor_value, window_key)

            session_calibration_info = {
                'original_percentage': session_percentages['max_percentage'],
                'calibrated_percentage': round(calibration['calibrated_value'] * 100, 1),
                'offset_applied': round(calibration['offset_applied'] * 100, 1),
                'confidence': calibration['confidence'],
                'status': calibration['status'],
                'dynamic_threshold': round(calibration['threshold'] * 100, 1),
                'window_key': window_key
            }

            # ìº˜ë¦¬ë¸Œë ˆì´ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë³´ì •ëœ ê°’ì„ ì‚¬ìš©
            # override, calibrated, learning ìƒíƒœ ëª¨ë‘ ì ìš©
            if calibration['status'] in ['override', 'calibrated', 'learning']:
                session_display_percentage = session_calibration_info['calibrated_percentage']
        except Exception as e:
            print(f"Warning: Session calibration failed: {e}")

    # Calibration ì ìš© (ì£¼ê°„)
    weekly_calibration_info = None
    weekly_display_percentage = weekly_percentages['max_percentage']  # ê¸°ë³¸ê°’

    if CALIBRATION_ENABLED:
        try:
            weekly_window_key = get_weekly_window_key()
            weekly_monitor_value = weekly_percentages['max_percentage'] / 100.0
            weekly_calibration = get_calibrated_value(weekly_monitor_value, weekly_window_key)

            weekly_calibration_info = {
                'original_percentage': weekly_percentages['max_percentage'],
                'calibrated_percentage': round(weekly_calibration['calibrated_value'] * 100, 1),
                'offset_applied': round(weekly_calibration['offset_applied'] * 100, 1),
                'confidence': weekly_calibration['confidence'],
                'status': weekly_calibration['status'],
                'dynamic_threshold': round(weekly_calibration['threshold'] * 100, 1),
                'window_key': weekly_window_key
            }

            # ìº˜ë¦¬ë¸Œë ˆì´ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë³´ì •ëœ ê°’ì„ ì‚¬ìš©
            if weekly_calibration['status'] in ['override', 'calibrated', 'learning']:
                weekly_display_percentage = weekly_calibration_info['calibrated_percentage']
        except Exception as e:
            print(f"Warning: Weekly calibration failed: {e}")

    # ì•Œë¦¼ ì²´í¬ ë° ì „ì†¡ (ìº˜ë¦¬ë¸Œë ˆì´ì…˜ëœ ê°’ ê¸°ì¤€)
    notified_thresholds = check_and_send_notifications(
        config,
        session_display_percentage,
        session_start.isoformat()
    )

    # ì¶œë ¥ ë°ì´í„° ìƒì„±
    output = {
        'status': 'active',
        'plan': config['plan'],
        'timezone': tz_name,
        'timezone_abbr': tz_abbr,
        'calibration': {
            'enabled': CALIBRATION_ENABLED,
            'session': session_calibration_info,
            'weekly': weekly_calibration_info,
            # Legacy compatibility (ì„¸ì…˜ ì •ë³´ë¥¼ 'info'ì—ë„ ìœ ì§€)
            'info': session_calibration_info
        },
        'notifications': {
            'enabled': config.get('notifications', {}).get('enabled', True),
            'thresholds': config.get('notifications', {}).get('thresholds', [80, 90, 95]),
            'notified_this_session': notified_thresholds
        },
        'session': {
            'usage': {
                'input_tokens': session_usage['input_tokens'],
                'output_tokens': session_usage['output_tokens'],
                'cache_creation_tokens': session_usage['cache_creation_tokens'],
                'cache_read_tokens': session_usage['cache_read_tokens'],
                'total_counted_tokens': session_usage['total_counted_tokens'],
                'messages_count': session_usage['messages_count']
            },
            'percentages': session_percentages,
            'limits': {
                'input_tokens_per_minute': session_limits['input_tokens_per_minute'],
                'output_tokens_per_minute': session_limits['output_tokens_per_minute'],
                'window_hours': session_limits['window_hours']
            },
            'window': {
                'start': session_start.isoformat(),
                'end': session_end.isoformat()
            },
            'reset': {
                'time': session_reset.strftime('%H:%M'),
                'time_12h': session_reset.strftime('%I:%M %p'),
                'iso': session_reset.isoformat(),
                'timezone': tz_name,
                'timezone_abbr': tz_abbr,
                'time_until_reset': session_time_until_reset,
                'note': f'{session_limits["window_hours"]}ì‹œê°„ rolling ìœˆë„ìš°'
            },
            'display': {
                'progress_bar': generate_progress_bar(session_display_percentage),
                'status_line': f"{session_display_percentage}% used, resets in {session_time_until_reset['human_readable']} ({session_reset.strftime('%H:%M')} {tz_abbr})"
            }
        },
        'weekly': {
            'usage': {
                'input_tokens': weekly_usage['input_tokens'],
                'output_tokens': weekly_usage['output_tokens'],
                'cache_creation_tokens': weekly_usage['cache_creation_tokens'],
                'cache_read_tokens': weekly_usage['cache_read_tokens'],
                'total_counted_tokens': weekly_usage['total_counted_tokens'],
                'messages_count': weekly_usage['messages_count']
            },
            'percentages': weekly_percentages,
            'limits': {
                'input_tokens_per_minute': weekly_limits['input_tokens_per_minute'],
                'output_tokens_per_minute': weekly_limits['output_tokens_per_minute'],
                'window_hours': weekly_limits['window_hours']
            },
            'window': {
                'start': weekly_start.isoformat(),
                'end': weekly_end.isoformat()
            },
            'reset': {
                'time': weekly_reset.strftime('%H:%M'),
                'time_12h': weekly_reset.strftime('%I:%M %p'),
                'iso': weekly_reset.isoformat(),
                'timezone': tz_name,
                'timezone_abbr': tz_abbr,
                'time_until_reset': weekly_time_until_reset,
                'note': '7ì¼ rolling ìœˆë„ìš°'
            },
            'display': {
                'progress_bar': generate_progress_bar(weekly_display_percentage),
                'status_line': f"{weekly_display_percentage}% used (7 days)"
            }
        },
        'timestamp': datetime.now(tz).isoformat()
    }

    return output


def save_output(data):
    """ì¶œë ¥ íŒŒì¼ ì €ì¥"""
    with open(OUTPUT_FILE, 'w') as f:
        json.dump(data, f, indent=2)


def daemon_mode(config, interval=60):
    """ë°ëª¬ ëª¨ë“œë¡œ ì§€ì† ì‹¤í–‰"""
    # Timezone ì„¤ì •
    tz_name = config['display_settings']['timezone']
    tz = ZoneInfo(tz_name)

    print(f"ğŸš€ Claude Usage Monitor Daemon v2 started")
    print(f"   Plan: {config['plan']['name']}")
    print(f"   Timezone: {tz_name}")
    print(f"   Output: {OUTPUT_FILE}")
    print(f"   Interval: {interval}s")
    print(f"   Press Ctrl+C to stop\\n")

    try:
        while True:
            # ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
            data = monitor_once(config)

            # íŒŒì¼ ì €ì¥
            save_output(data)

            # ìƒíƒœ ì¶œë ¥
            if data['status'] == 'active':
                session_bar = data['session']['display']['progress_bar']
                # ìº˜ë¦¬ë¸Œë ˆì´ì…˜ëœ ê°’ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©, ì•„ë‹ˆë©´ ì›ë³¸ ì‚¬ìš©
                if data['calibration']['enabled'] and data['calibration']['session']:
                    session_pct = data['calibration']['session']['calibrated_percentage']
                else:
                    session_pct = data['session']['percentages']['max_percentage']

                if data['calibration']['enabled'] and data['calibration']['weekly']:
                    weekly_pct = data['calibration']['weekly']['calibrated_percentage']
                else:
                    weekly_pct = data['weekly']['percentages']['max_percentage']

                print(f"[{datetime.now(tz).strftime('%H:%M:%S')}] "
                      f"Session: {session_bar} {session_pct}% | "
                      f"Weekly: {weekly_pct}%")
            else:
                print(f"[{datetime.now(tz).strftime('%H:%M:%S')}] "
                      f"No active session")

            # ëŒ€ê¸°
            time.sleep(interval)

    except KeyboardInterrupt:
        print("\\n\\nâœ… Daemon stopped")


def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    parser = argparse.ArgumentParser(description='Claude Usage Monitor Daemon v2')
    parser.add_argument('--once', action='store_true',
                        help='Run once and exit (default: daemon mode)')
    parser.add_argument('--interval', type=int, default=60,
                        help='Update interval in seconds (default: 60)')

    args = parser.parse_args()

    # ì„¤ì • ë¡œë“œ
    config = load_config()
    if not config:
        return 1

    if args.once:
        # í•œ ë²ˆë§Œ ì‹¤í–‰
        data = monitor_once(config)
        save_output(data)
        print(json.dumps(data, indent=2))
    else:
        # ë°ëª¬ ëª¨ë“œ
        daemon_mode(config, args.interval)

    return 0


if __name__ == '__main__':
    exit(main())
