#!/bin/bash
# Chrome Extension ë°ì´í„°ë¥¼ ì¦‰ì‹œ ë™ê¸°í™” (Web Extension ì „ìš© ë²„ì „)
# ì‚¬ìš©ë²•: chrome extensionì—ì„œ Scrape Now í´ë¦­ í›„ ì´ ëª…ë ¹ì–´ ì‹¤í–‰

SOURCE_FILE="$HOME/Downloads/claude-auto-usage.json"
DEST_FILE="/tmp/claude-web-usage.json"

if [ ! -f "$SOURCE_FILE" ]; then
    echo "âŒ Extension íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
    echo "   Chrome Extensionì—ì„œ 'Scrape Now'ë¥¼ ë¨¼ì € í´ë¦­í•˜ì„¸ìš”"
    exit 1
fi

echo "ðŸ“¥ Syncing extension data..."

# JSON íŒŒì‹±
SESSION=$(jq -r '.session' "$SOURCE_FILE")
WEEKLY=$(jq -r '.weekly' "$SOURCE_FILE")
SESSION_RESET=$(jq -r '.sessionResetTime // ""' "$SOURCE_FILE")
WEEKLY_RESET=$(jq -r '.weeklyResetTime // ""' "$SOURCE_FILE")

if [ "$SESSION" == "null" ] || [ "$WEEKLY" == "null" ]; then
    echo "âŒ Invalid JSON format"
    rm "$SOURCE_FILE"
    exit 1
fi

echo "âœ… Data from Extension:"
echo "   Session: ${SESSION}%"
echo "   Weekly: ${WEEKLY}%"
if [ -n "$SESSION_RESET" ]; then
    echo "   Session resets: ${SESSION_RESET}"
fi
if [ -n "$WEEKLY_RESET" ]; then
    echo "   Weekly resets: ${WEEKLY_RESET}"
fi
echo ""

# ê°„ë‹¨í•œ JSON ìƒì„± (Web Extension ì „ìš©)
cat > "$DEST_FILE" << EOF
{
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "source": "chrome_extension",
  "session": {
    "percentage": ${SESSION},
    "reset_time": "${SESSION_RESET}",
    "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
  },
  "weekly": {
    "percentage": ${WEEKLY},
    "reset_time": "${WEEKLY_RESET}",
    "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
  }
}
EOF

# ì›ë³¸ íŒŒì¼ ì‚­ì œ
rm "$SOURCE_FILE"

# SwiftBar ìƒˆë¡œê³ ì¹¨
open "swiftbar://refreshallplugins" 2>/dev/null
touch "$HOME/Library/Application Support/SwiftBar/ClaudeUsage.1m.sh" 2>/dev/null

echo "âœ… Sync complete! SwiftBar updated to ${SESSION}%"
